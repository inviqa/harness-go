#!/bin/bash

set -e
set -x

function main()
{
    test "$1" "$2"
}

function test()
(
    local mode="$1"
    local goversion="$2"

    local path_harness="."
    local path_test="./.tmp-test"

    if [ -d "${path_test}" ]; then
        rm -rf "${path_test}"
    fi

    cp -ap "${path_harness}/.ci/${goversion}/sample-${mode}" "${path_test}"
    cd ${path_test}
    mkdir "./.my127ws/"
    cp -ap "../${path_harness}/"* "./.my127ws/"

    ws install

    ws helm kubeval qa

    ws disable
    ws enable

    sleep 5

    if [ ! "$(docker ps -q -f name=ci-go-sample_app)" ]; then
      echo "The app container has stopped running unexpectedly."
      exit 1
    fi
)

function clean()
{
    local path_test="./.tmp-test"

    if [ -d "$path_test" ]; then
        (cd $path_test && ws destroy)
        rm -rf $path_test
    fi
}

trap 'clean' EXIT
main "$@"
